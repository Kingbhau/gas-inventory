<div class="sale-entry-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">New Sale Entry</h1>
    <p class="page-subtitle">Record a new sale transaction</p>
  </div>

  <!-- Sale Entry Form -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Sale Details</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="saleForm" (ngSubmit)="onSubmit()" class="sale-form">
        <!-- Two Column Layout for Selection Fields -->
        <div class="form-row">
          <!-- Warehouse Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Warehouse"
              [required]="true"
              [items]="warehouses"
              [displayKey]="'name'"
              placeholder="Warehouse name..."
              (selectedChange)="onWarehouseSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="saleForm.get('warehouseId')?.invalid && saleForm.get('warehouseId')?.touched" class="error-message">
              Warehouse is required
            </div>
          </div>

          <!-- Customer Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Customer"
              [required]="true"
              [items]="customers"
              [displayKey]="'name'"
              placeholder="Customer name..."
              (selectedChange)="onCustomerSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="saleForm.get('customerId')?.invalid && saleForm.get('customerId')?.touched" class="error-message">
              Customer is required
            </div>
          </div>
        </div>

        <!-- Variant Selection -->
        <app-autocomplete-input
          label="Cylinder Variant"
          [required]="true"
          [items]="filteredVariants"
          [displayKey]="'name'"
          placeholder="Variant name..."
          (selectedChange)="onVariantSelected($event)"
        ></app-autocomplete-input>
        <div *ngIf="saleForm.get('variantId')?.invalid && saleForm.get('variantId')?.touched" class="error-message">
          Variant is required
        </div>

        <!-- Two Column Layout -->
        <div class="form-row">
          <!-- Filled Cylinders Issued -->
          <div class="form-group">
            <label class="form-label">Filled Cylinders Issued <span class="required">*</span></label>
            <input 
              formControlName="filledIssuedQty" 
              type="number" 
              class="form-control" 
              placeholder="0"
              (change)="calculateTotal()">
            <div *ngIf="saleForm.get('filledIssuedQty')?.invalid && saleForm.get('filledIssuedQty')?.touched" class="error-message">
              Valid quantity required
            </div>
          </div>

          <!-- Empty Cylinders Received -->
          <div class="form-group">
            <label class="form-label">Empty Cylinders Received</label>
            <input 
              formControlName="emptyReceivedQty" 
              type="number" 
              class="form-control" 
              placeholder="0"
              (change)="calculateTotal()">
          </div>
        </div>

        <!-- Two Column Layout for Pricing -->
        <div class="form-row">
          <!-- Base Price -->
          <div class="form-group">
            <label class="form-label">Base Price Per Unit</label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input 
                formControlName="basePrice" 
                type="number" 
                class="form-control" 
                placeholder="0.00"
                [readonly]="true"
                (change)="calculateTotal()">
            </div>
            <div *ngIf="saleForm.get('basePrice')?.invalid && saleForm.get('basePrice')?.touched" class="error-message">
              Price required
            </div>
          </div>

          <!-- Discount Price (Read-only) -->
          <div class="form-group">
            <label class="form-label">Discount Amount Per Unit</label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input 
                type="number" 
                class="form-control" 
                [value]="discountPrice"
                [readonly]="true"
                placeholder="0.00"
                (change)="calculateTotal()">
            </div>
          </div>
        </div>

        <!-- Two Column Layout for Amount Fields -->
        <div class="form-row">
          <!-- Amount Received -->
          <div class="form-group">
            <label class="form-label">Amount Received (₹)</label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input 
                formControlName="amountReceived" 
                type="text" 
                class="form-control" 
                placeholder="0.00"
                indianCurrencyFormat>
            </div>
            <div *ngIf="saleForm.get('amountReceived')?.invalid && saleForm.get('amountReceived')?.touched" class="error-message">
              Please enter amount received
            </div>
          </div>

          <!-- Payment Mode -->
          <div class="form-group">
            <label class="form-label">Payment Mode</label>
            <select formControlName="modeOfPayment" class="form-control">
              <option [value]="null" disabled hidden>Select Payment Mode</option>
              <option *ngFor="let mode of paymentModes" [value]="mode.name">{{ mode.name }}</option>
            </select>
            <div *ngIf="saleForm.get('modeOfPayment')?.invalid && saleForm.get('modeOfPayment')?.touched" class="error-message">
              Please select payment mode
            </div>
          </div>

          <!-- Bank Account Selection (visible only when payment mode requires bank account) -->
          <div class="form-group" *ngIf="saleForm.get('modeOfPayment')?.value && getSelectedPaymentMode(saleForm.get('modeOfPayment')?.value)?.isBankAccountRequired">
            <label class="form-label">Bank Account</label>
            <select formControlName="bankAccountId" class="form-control">
              <option [value]="null" disabled>Select Bank Account</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.bankName }} - {{ account.accountNumber }}
              </option>
            </select>
            <div *ngIf="saleForm.get('bankAccountId')?.invalid && saleForm.get('bankAccountId')?.touched" class="error-message">
              Please select a bank account for this payment mode
            </div>
          </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
          <div class="summary-row">
            <span class="summary-label">Quantity:</span>
            <span class="summary-value">{{ saleForm.get('filledIssuedQty')?.value || 0 }} units</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Base Price Per Unit:</span>
            <span class="summary-value">{{ saleForm.get('basePrice')?.value | indianCurrency }}</span>
          </div>
          <div class="summary-row" *ngIf="discountPrice > 0">
            <span class="summary-label">Discount Per Unit:</span>
            <span class="summary-value" style="color: #d32f2f;">-{{ discountPrice | indianCurrency }}</span>
          </div>
          <div class="summary-row" *ngIf="discountPrice > 0">
            <span class="summary-label">Price Per Unit After Discount:</span>
            <span class="summary-value" style="color: #28a745;">{{ (saleForm.get('basePrice')?.value - discountPrice) | indianCurrency }}</span>
          </div>
          <div class="summary-row" *ngIf="discountAmount > 0">
            <span class="summary-label">Total Discount (Savings):</span>
            <span class="summary-value" style="color: #28a745;">-{{ discountAmount | indianCurrency }}</span>
          </div>
          <div class="summary-row total">
            <span class="summary-label">Total Amount to Pay:</span>
            <span class="summary-value">{{ totalAmount | indianCurrency }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Amount Received:</span>
            <span class="summary-value" style="color: #0066cc;">{{ saleForm.get('amountReceived')?.value | indianCurrency }}</span>
          </div>
          <div class="summary-row" [style.color]="(totalAmount - (saleForm.get('amountReceived')?.value || 0)) > 0 ? '#d32f2f' : '#28a745'">
            <span class="summary-label">Amount Due:</span>
            <span class="summary-value">{{ (totalAmount - (saleForm.get('amountReceived')?.value || 0)) | indianCurrency }}</span>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="!saleForm.valid">
            <span>✓</span> Save Sale
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()">
            <span>↻</span> Reset
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="success-alert">
        ✓ {{ successMessage }}
      </div>
    </div>
  </div>
</div>
