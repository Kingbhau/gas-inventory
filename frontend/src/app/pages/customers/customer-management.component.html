<div class="customers-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Customers</h1>
      <p class="page-subtitle">Manage all customer accounts and cylinder ledgers</p>
    </div>
    <button (click)="openAddForm()" class="btn btn-primary">
      <fa-icon [icon]="faPlus"></fa-icon>
      Add Customer
    </button>
  </div>

  <!-- Search and Filter -->
  <div class="search-section">
    <div class="search-container">
      <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Search by name, mobile, or address..."
        class="search-input">
    </div>
  </div>

  <!-- Customers Table Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">All Customers</h3>
      <p class="card-subtitle">Total: {{ paginatedCustomers.length }} customers</p>
    </div>
    <div class="card-body">
      <div *ngIf="paginatedCustomers.length > 0; else noData" class="table-wrapper" [class.dropdown-open]="isAnyDropdownOpen">
        <div class="mobile-table-scroll">
          <table class="data-table">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Mobile</th>
              <th class="text-center">Return Pending</th>
              <th class="text-center">Filled Units</th>
              <th class="text-center" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let customer of paginatedCustomers">
              <td class="font-semibold">{{ customer.name }}</td>
              <td>{{ customer.mobile }}</td>
              <td class="text-center">
                <span *ngIf="customer.returnPendingUnits > 0" class="badge badge-warning">{{ customer.returnPendingUnits }}</span>
                <span *ngIf="!customer.returnPendingUnits || customer.returnPendingUnits <= 0" class="text-muted">0</span>
              </td>
              <td class="text-center">
                <span *ngIf="customer.filledUnits > 0" class="badge badge-success">{{ customer.filledUnits }}</span>
                <span *ngIf="!customer.filledUnits || customer.filledUnits <= 0" class="text-muted">0</span>
              </td>
              <td class="text-center actions-cell">
                <div class="dropdown" style="position: relative; display: inline-block;">
                  <button class="action-btn" (click)="customer.showMenu = !customer.showMenu" title="More Actions">
                    <fa-icon [icon]="faEllipsisV"></fa-icon>
                  </button>
                  <div *ngIf="customer.showMenu">
                    <div class="dropdown-backdrop" (click)="customer.showMenu = false"></div>
                    <div class="dropdown-menu show" [ngClass]="{'bottom-fix': isLastRow(customer)}">
                      <button class="dropdown-item" (click)="openDetailsModal(customer); customer.showMenu = false">
                        <fa-icon [icon]="faEye"></fa-icon> View Details
                      </button>
                      <button class="dropdown-item" (click)="viewLedger(customer.id); customer.showMenu = false">
                        <fa-icon [icon]="faBook"></fa-icon> View Ledger
                      </button>
                      <button class="dropdown-item" (click)="editCustomer(customer); customer.showMenu = false">
                        <fa-icon [icon]="faPencil"></fa-icon> Edit
                      </button>
                      <button class="dropdown-item danger" (click)="deleteCustomer(customer.id); customer.showMenu = false">
                        <fa-icon [icon]="faTrash"></fa-icon> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
          </table>
        </div>
      </div>
      <!-- Pagination Controls -->
      <div *ngIf="paginatedCustomers.length > 0" class="pagination">
        <button 
          (click)="onPageChange(customerPage - 1)" 
          [disabled]="customerPage === 1"
          class="btn btn-secondary">
          ← Previous
        </button>
        <span class="page-info">Page {{ customerPage }} of {{ getTotalPages() }}</span>
        <button 
          (click)="onPageChange(customerPage + 1)" 
          [disabled]="customerPage === getTotalPages()"
          class="btn btn-secondary">
          Next →
        </button>
        <div style="display: flex; align-items: center; gap: 0.25rem; margin-left: 2rem;">
          <span class="page-size-label">Show</span>
          <select [(ngModel)]="customerPageSize" (ngModelChange)="onPageSizeChange($event)" class="page-size-select">
            <option *ngFor="let size of [5,10,20,50,100]" [value]="size">{{ size }}</option>
          </select>
          <span class="page-size-label">per page</span>
        </div>
      </div>
      <!-- Details Modal -->
            <div *ngIf="showDetailsModal && detailsCustomer" class="modal-overlay" (click)="closeDetailsModal()">
              <div class="modal-content details-modal" (click)="$event.stopPropagation()">
                <div class="modal-header details-modal-header">
                  <div class="details-title-group">
                    <h2 class="details-title">Customer Details</h2>
                      <!-- Status badge removed as requested -->
                  </div>
                  <button class="modal-close" (click)="closeDetailsModal()">
                    <fa-icon [icon]="faTimes"></fa-icon>
                  </button>
                </div>
                <div class="modal-body details-modal-body">
                                    <span class="details-status-badge" [ngClass]="{'inactive': !detailsCustomer.active}">
                                      <fa-icon [icon]="detailsCustomer.active ? faUsers : faTimes"></fa-icon>
                                      {{ detailsCustomer.active ? 'Active' : 'Inactive' }}
                                    </span>
                  <div class="details-section">
                    <div class="details-label">Name</div>
                    <div class="details-value">{{ detailsCustomer.name }}</div>
                  </div>
                  <div class="details-section">
                    <div class="details-label">Mobile</div>
                    <div class="details-value">{{ detailsCustomer.mobile }}</div>
                  </div>
                  <div class="details-section">
                    <div class="details-label">Address</div>
                    <div class="details-value">{{ detailsCustomer.address }}</div>
                  </div>
                  <div class="details-section">
                    <div class="details-label">Last Sale</div>
                    <div class="details-value">{{ detailsCustomer.lastSaleDate | date: 'dd MMM yyyy' }}</div>
                  </div>
                  <div class="details-section">
                    <div class="details-label">Return Pending</div>
                    <div class="details-value">{{ detailsCustomer.returnPendingUnits }}</div>
                  </div>
                  <div class="details-section">
                    <div class="details-label">Filled Units</div>
                    <div class="details-value">{{ detailsCustomer.filledUnits }}</div>
                  </div>

                  <!-- Variant Prices Section -->
                  <div class="details-section">
                    <div class="details-label">Variant Pricing</div>
                    <div *ngIf="detailsVariantPrices && detailsVariantPrices.length > 0; else noPrices" class="variant-prices-table">
                      <table>
                        <thead>
                          <tr>
                            <th>Variant</th>
                            <th>Sale Price (₹)</th>
                            <th>Discount Price (₹)</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let price of detailsVariantPrices">
                            <td>{{ price.variantName }}</td>
                            <td>{{ price.salePrice | number: '1.2-2' }}</td>
                            <td>{{ price.discountPrice | number: '1.2-2' }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <ng-template #noPrices>
                      <div class="no-prices-message">No pricing configured for any variants</div>
                    </ng-template>
                  </div>
                </div>
                <div class="modal-footer details-modal-footer">
                  <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Close</button>
                </div>
              </div>
            </div>

      <ng-template #noData>
        <div class="empty-state">
          <div class="empty-icon"><fa-icon [icon]="faUsers"></fa-icon></div>
          <h4 class="empty-title">No Customers Found</h4>
          <p class="empty-subtitle">Start by adding your first customer</p>
          <button (click)="openAddForm()" class="btn btn-primary">
            <fa-icon [icon]="faPlus"></fa-icon>
            Add Customer
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showForm" class="modal-overlay" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2 class="modal-title">{{ editingId ? 'Edit Customer' : 'Add New Customer' }}</h2>
          <p class="modal-subtitle">{{ editingId ? 'Update customer information' : 'Create a new customer account' }}</p>
        </div>
        <button class="modal-close" (click)="closeForm()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
      <form [formGroup]="customerForm" (ngSubmit)="saveCustomer()" class="modal-body">
        <div class="form-group">
          <label class="form-label">Full Name <span class="required">*</span></label>
          <input formControlName="name" type="text" class="form-control" placeholder="Enter customer name">
          <div *ngIf="customerForm.get('name')?.invalid && customerForm.get('name')?.touched" class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Name is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Mobile Number <span class="required">*</span></label>
          <input formControlName="mobile" type="tel" class="form-control" placeholder="10-digit mobile number">
          <div *ngIf="customerForm.get('mobile')?.invalid && customerForm.get('mobile')?.touched" class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Valid 10-digit mobile required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Address</label>
          <textarea formControlName="address" class="form-control" rows="3" placeholder="Customer address and location details"></textarea>
        </div>

        <!-- Variant Configuration Section -->
        <div class="form-group">
          <label class="form-label">Select Variants <span class="required">*</span></label>
          <div class="variant-selection">
            <div *ngFor="let variant of variants" class="variant-checkbox">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [value]="variant.id" 
                  [checked]="isVariantSelected(variant.id)"
                  (change)="toggleVariantSelection(variant.id)"
                  class="checkbox-input">
                <span class="checkbox-text">{{ variant.name }} ({{ variant.weightKg }}kg)</span>
              </label>
            </div>
          </div>
          <div *ngIf="customerForm.get('configuredVariants')?.invalid && customerForm.get('configuredVariants')?.touched" 
               class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Select at least one variant
          </div>
        </div>

        <!-- Variant-Specific Pricing Section -->
        <div class="form-section pricing-section" *ngIf="variantPricesArray.length > 0">
          <h4 class="section-title">Pricing for Selected Variants (Required)</h4>
          <div class="pricing-grid">
            <div *ngFor="let priceControl of variantPricesArray.controls; let i = index" 
                 [formGroup]="$any(priceControl)" class="pricing-card" 
                 [class.has-error]="priceControl.invalid && priceControl.touched">
              <div class="variant-header">
                <strong>{{ priceControl.get('variantName')?.value }}</strong>
              </div>
              <div class="pricing-inputs">
                <div class="price-input">
                  <label class="form-label small">Sale Price <span class="required">*</span></label>
                  <input formControlName="salePrice" type="number" class="form-control" 
                         placeholder="0.00" step="0.01" min="0">
                  <div *ngIf="priceControl.get('salePrice')?.hasError('required') && priceControl.get('salePrice')?.touched" 
                       class="form-error">
                    <fa-icon [icon]="faExclamation"></fa-icon> Sale price is required
                  </div>
                  <div *ngIf="priceControl.get('salePrice')?.hasError('min') && priceControl.get('salePrice')?.touched && priceControl.get('salePrice')?.value !== ''" 
                       class="form-error">
                    <fa-icon [icon]="faExclamation"></fa-icon> Must be non-negative
                  </div>
                </div>
                <div class="price-input">
                  <label class="form-label small">Discount Price <span class="required">*</span></label>
                  <input formControlName="discountPrice" type="number" class="form-control" 
                         placeholder="0.00" step="0.01" min="0">
                  <div *ngIf="priceControl.get('discountPrice')?.hasError('required') && priceControl.get('discountPrice')?.touched" 
                       class="form-error">
                    <fa-icon [icon]="faExclamation"></fa-icon> Discount price is required
                  </div>
                  <div *ngIf="priceControl.get('discountPrice')?.hasError('min') && priceControl.get('discountPrice')?.touched && priceControl.get('discountPrice')?.value !== ''" 
                       class="form-error">
                    <fa-icon [icon]="faExclamation"></fa-icon> Must be non-negative
                  </div>
                  <div *ngIf="priceControl.get('discountPrice')?.hasError('discountGreaterThanSale') && priceControl.get('discountPrice')?.touched" 
                       class="form-error">
                    <fa-icon [icon]="faExclamation"></fa-icon> Discount price cannot be greater than sale price
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Active Status <span class="required">*</span></label>
          <select formControlName="active" class="form-control">
            <option [ngValue]="true">Active</option>
            <option [ngValue]="false">Inactive</option>
          </select>
        </div>
       

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!customerForm.valid">
            {{ editingId ? 'Update Customer' : 'Create Customer' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ledger Modal -->
  <div *ngIf="showLedger" class="modal-overlay" (click)="closeLedger()">
    <div class="modal-content wide" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ selectedCustomer?.name }} - Cylinder Ledger</h2>
        <button class="modal-close" (click)="closeLedger()">✕</button>
      </div>
      <div class="modal-body">
        <div class="variant-filter">
          <label for="ledgerVariantSelect">Variant:</label>
          <app-autocomplete-input
            [items]="variants"
            [displayKey]="'name'"
            placeholder="All Variants"
            (selectedChange)="ledgerFilterVariant = $event?.name || ''"
          ></app-autocomplete-input>
        </div>
        <div class="mobile-table-scroll">
          <table class="ledger-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Variant</th>
                <th class="text-center">Filled Issued</th>
                <th class="text-center">Empty Received</th>
                <th class="text-center">Balance</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of filteredLedgerEntries">
                <td>{{ entry.transactionDate | date: 'dd MMM yyyy' }}</td>
                <td>
                  <span class="variant-badge" [ngStyle]="{'background-color': getVariantColor(entry.variantName)}"></span>
                  {{ entry.variantName }}
                </td>
                <td class="text-center">{{ entry.filledOut }}</td>
                <td class="text-center">{{ entry.emptyIn }}</td>
                <td class="text-center" [class.negative]="entry.balance < 0">
                  {{ entry.balance }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="text-align:center; margin-top:1rem;" *ngIf="canShowMoreLedger">
          <button class="btn btn-secondary" (click)="showMoreLedger()" [disabled]="isLoadingMoreLedger">
            {{ isLoadingMoreLedger ? 'Loading...' : 'Show More' }}
          </button>
        </div>
        <div class="ledger-summary">
          <div class="summary-row">
            <span class="label">Per Variant Summary:</span>
          </div>
          <div class="summary-row" *ngFor="let variant of filteredVariants">
            <span class="label">{{ variant.name }} ({{ variant.weightKg }}kg):</span>
            <span class="value">
              Filled with customer: {{ getFilledUnitsForVariant(variant.name) }}
            </span>
          </div>
          <div class="summary-row">
            <span class="label">Return Pending:</span>
            <span class="value">{{ totalPendingUnits }} units</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeLedger()">Close</button>
      </div>
    </div>
  </div>
</div>
