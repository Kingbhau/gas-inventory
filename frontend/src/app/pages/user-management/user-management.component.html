<div class="customers-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Users</h1>
      <p class="page-subtitle">Manage all user accounts and roles</p>
    </div>
    <button (click)="openAddForm()" class="btn btn-primary">
      <fa-icon [icon]="faPlus"></fa-icon>
      Add User
    </button>
  </div>

  <!-- Search and Filter -->
  <div class="search-section">
    <div class="search-container">
      <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Search by name, mobile, or address..."
        class="search-input">
    </div>
  </div>

  <!-- Users Table Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">All Users</h3>
      <p class="card-subtitle">Total: {{ paginatedUsers.length }} users</p>
    </div>
    <div class="card-body">
      <div *ngIf="paginatedUsers.length > 0; else noData" class="table-wrapper" [class.dropdown-open]="isAnyDropdownOpen">
        <div class="mobile-table-scroll">
          <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Mobile</th>
              <th>Role</th>
              <th>Status</th>
              <th class="text-center" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of paginatedUsers">
              <td class="font-semibold">{{ user.name }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.mobileNo }}</td>
              <td>{{ user.role }}</td>
              <td>
                <span [class.active]="user.active" [class.inactive]="!user.active" class="status-badge">
                  {{ user.active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="text-center actions-cell">
                <div class="dropdown" style="position: relative; display: inline-block;">
                  <button class="action-btn" (click)="user.showMenu = !user.showMenu" title="More Actions">
                    <fa-icon [icon]="faEllipsisV"></fa-icon>
                  </button>
                  <div *ngIf="user.showMenu">
                    <div class="dropdown-backdrop" (click)="user.showMenu = false"></div>
                    <div class="dropdown-menu show" [ngClass]="{'bottom-fix': isLastRow(user)}">
                      <button class="dropdown-item" (click)="openDetailsModal(user); user.showMenu = false">
                        <fa-icon [icon]="faEye"></fa-icon> View Details
                      </button>
                      <button class="dropdown-item" (click)="editUser(user); user.showMenu = false">
                        <fa-icon [icon]="faEdit"></fa-icon> Edit
                      </button>
                      <!-- <button class="dropdown-item danger" (click)="openDeleteModal(user); user.showMenu = false">
                        <fa-icon [icon]="faTrash"></fa-icon> Delete
                      </button> -->
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Delete Confirmation Modal (Global, outside table) -->
    <div *ngIf="showDeleteModal" class="modal-overlay delete-modal-overlay" (click)="closeDeleteModal()">
      <div class="delete-modal-card" (click)="$event.stopPropagation()">
        <div class="delete-modal-icon-row">
          <div class="delete-modal-icon-bg">
            <fa-icon [icon]="faExclamation" class="delete-modal-icon"></fa-icon>
          </div>
        </div>
        <div class="delete-modal-content">
          <h2 class="delete-modal-title">Delete User?</h2>
          <div class="delete-modal-user-name">{{ deleteUserTarget?.name }}</div>
          <div class="delete-modal-message">This action cannot be undone. Are you sure you want to delete this user?</div>
        </div>
        <div class="delete-modal-actions">
          <button type="button" class="delete-modal-cancel" (click)="closeDeleteModal()">
            <fa-icon [icon]="faTimes"></fa-icon> Cancel
          </button>
          <button type="button" class="delete-modal-confirm" (click)="confirmDeleteUser()">
            <fa-icon [icon]="faTrash"></fa-icon> Delete
          </button>
        </div>
      </div>
    </div>
      <!-- Pagination Controls -->
      <div *ngIf="paginatedUsers.length > 0" class="pagination">
        <button 
          (click)="onPageChange(userPage - 1)" 
          [disabled]="userPage === 1"
          class="btn btn-secondary">
          ← Previous
        </button>
        <span class="page-info">Page {{ userPage }} of {{ getTotalPages() }}</span>
        <button 
          (click)="onPageChange(userPage + 1)" 
          [disabled]="userPage === getTotalPages()"
          class="btn btn-secondary">
          Next →
        </button>
        <div style="display: flex; align-items: center; gap: 0.25rem; margin-left: 2rem;">
          <span class="page-size-label">Show</span>
          <select [(ngModel)]="userPageSize" (ngModelChange)="onPageSizeChange($event)" class="page-size-select">
            <option *ngFor="let size of [5,10,20,50,100]" [value]="size">{{ size }}</option>
          </select>
          <span class="page-size-label">per page</span>
        </div>
      </div>
      <ng-template #noData>
        <div class="empty-state">
          <div class="empty-icon"><fa-icon [icon]="faUsers"></fa-icon></div>
          <h4 class="empty-title">No Users Found</h4>
          <p class="empty-subtitle">Start by adding your first user</p>
          <button (click)="openAddForm()" class="btn btn-primary">
            <fa-icon [icon]="faPlus"></fa-icon>
            Add User
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showForm" class="modal-overlay" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2 class="modal-title">{{ editingId ? 'Edit User' : 'Add New User' }}</h2>
          <p class="modal-subtitle">{{ editingId ? 'Update user information' : 'Create a new user account' }}</p>
        </div>
        <button class="modal-close" (click)="closeForm()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="modal-body">
        <div class="form-group">
          <label class="form-label">Username <span class="required">*</span></label>
          <input formControlName="username" type="text" class="form-control" placeholder="Enter username" [readonly]="editingId">
          <div *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched" class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Username is required
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Full Name <span class="required">*</span></label>
          <input formControlName="name" type="text" class="form-control" placeholder="Enter user name">
          <div *ngIf="userForm.get('name')?.invalid && userForm.get('name')?.touched" class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Name is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Mobile Number <span class="required">*</span></label>
          <input formControlName="mobileNo" type="tel" class="form-control" placeholder="10-digit mobile number">
          <div *ngIf="userForm.get('mobileNo')?.invalid && userForm.get('mobileNo')?.touched" class="form-error">
            <fa-icon [icon]="faExclamation"></fa-icon> Valid 10-digit mobile required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Active Status <span class="required">*</span></label>
          <select formControlName="active" class="form-control">
            <option [ngValue]="true">Active</option>
            <option [ngValue]="false">Inactive</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Role <span class="required">*</span></label>
          <select formControlName="role" class="form-control">
            <option value="">Select Role</option>
            <option value="MANAGER">Manager</option>
            <option value="STAFF">Staff</option>
          </select>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeForm()" [disabled]="isSubmitting">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!userForm.valid || isSubmitting">
            {{ isSubmitting ? 'Saving...' : (editingId ? 'Update User' : 'Create User') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Details Modal -->
  <div *ngIf="showDetailsModal && detailsUser" class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header details-modal-header">
        <div class="details-title-group">
          <h2 class="details-title">User Details</h2>
        </div>
        <button class="modal-close" (click)="closeDetailsModal()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
      <div class="modal-body details-modal-body">
        <span [class.active]="detailsUser.active" [class.inactive]="!detailsUser.active" class="status-badge">
          <fa-icon [icon]="detailsUser.active ? faUsers : faTimes"></fa-icon>
          {{ detailsUser.active ? 'Active' : 'Inactive' }}
        </span>
        <div class="details-section">
          <div class="details-label">Name</div>
          <div class="details-value">{{ detailsUser.name }}</div>
        </div>
        <div class="details-section">
          <div class="details-label">Username</div>
          <div class="details-value">{{ detailsUser.username }}</div>
        </div>
        <div class="details-section">
          <div class="details-label">Mobile</div>
          <div class="details-value">{{ detailsUser.mobileNo }}</div>
        </div>
        <div class="details-section">
          <div class="details-label">Role</div>
          <div class="details-value">{{ detailsUser.role }}</div>
        </div>
      </div>
      <div class="modal-footer details-modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>

