<div class="bank-deposit-history-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Bank Deposits History</h1>
    <p class="page-subtitle">Track all client deposits made to bank accounts</p>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <div class="filter-row">
      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <input type="date" [(ngModel)]="filterFromDate" class="filter-input">
      </div>
      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <input type="date" [(ngModel)]="filterToDate" class="filter-input" [min]="filterFromDate">
      </div>
      <div class="filter-group">
        <label class="filter-label">Bank Account</label>
        <select [(ngModel)]="filterBankAccountId" (ngModelChange)="onBankAccountChange($event)" class="filter-input">
          <option [ngValue]="null">All Accounts</option>
          <option *ngFor="let account of bankAccounts" [ngValue]="account.id">
            {{ account.bankName }} - {{ account.accountNumber }}
          </option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Payment Mode</label>
        <select [(ngModel)]="filterPaymentMode" class="filter-input">
          <option value="">All Modes</option>
          <option *ngFor="let mode of paymentModes" [value]="mode.name">
            {{ mode.name }}
          </option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Reference #</label>
        <input type="text" [(ngModel)]="filterSearchTerm" class="filter-input" placeholder="Search reference...">
      </div>
    </div>
    <div class="filter-row" style="margin-top: 1rem;">
      <div class="filter-actions">
        <button (click)="applyFilters()" class="btn btn-primary">Search</button>
        <button (click)="resetFilters()" class="btn btn-secondary">Reset</button>
        <button (click)="exportToPdf()" class="btn btn-secondary"><fa-icon [icon]="faDownload"></fa-icon> Export PDF</button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="report-summary">
    <div class="summary-card">
      <span class="label">Total Deposits</span>
      <span class="value">{{ totalAmount | indianCurrency }}</span>
    </div>
    <div class="summary-card">
      <span class="label">No. of Deposits</span>
      <span class="value">{{ totalElements }}</span>
    </div>
    <div class="summary-card">
      <span class="label">Avg. Deposit</span>
      <span class="value">{{ (totalElements > 0 ? totalAmount / totalElements : 0) | indianCurrency }}</span>
    </div>
  </div>

  <!-- Deposits Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Deposit Records</h3>
      <span class="record-count">{{ totalElements }} records</span>
    </div>
    <div class="card-body">
      <div *ngIf="paginatedDeposits.length > 0; else noData" class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Reference #</th>
              <th>Bank Account</th>
              <th>Amount</th>
              <th>Mode</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let deposit of paginatedDeposits">
              <td>{{ deposit.depositDate | date: 'dd MMM yyyy' }}</td>
              <td><strong>{{ deposit.referenceNumber || '-' }}</strong></td>
              <td>{{ getBankAccountName(deposit.bankAccountId) }}</td>
              <td class="amount">₹{{ deposit.depositAmount | number: '1.2-2' }}</td>
              <td>{{ deposit.paymentMode }}</td>
              <td>
                <button class="btn-action" (click)="viewDeposit(deposit)" title="View Details">
                  <fa-icon [icon]="faEye"></fa-icon>
                </button>
                <button class="btn-action" (click)="editDeposit(deposit)" title="Edit">
                  <fa-icon [icon]="faEdit"></fa-icon>
                </button>
                <button class="btn-action" (click)="deleteDeposit(deposit)" title="Delete">
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Data Message -->
      <ng-template #noData>
        <div class="no-data">
          <p><fa-icon [icon]="faClipboard"></fa-icon> No bank deposits found</p>
        </div>
      </ng-template>

      <!-- Pagination -->
      <div *ngIf="deposits.length > 0" class="pagination">
        <button 
          (click)="previousPage()" 
          [disabled]="currentPage === 1"
          class="btn btn-secondary">
          ← Previous
        </button>
        <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
        <button 
          (click)="nextPage()" 
          [disabled]="currentPage === totalPages"
          class="btn btn-secondary">
          Next →
        </button>
        <div style="display: flex; align-items: center; gap: 0.25rem; margin-left: 2rem;">
          <span class="page-size-label">Show</span>
          <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)" class="page-size-select">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
          <span class="page-size-label">per page</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Deposit Modal -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Edit Bank Deposit</h3>
        <button class="modal-close" (click)="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editForm">
          <div class="form-group">
            <label class="form-label">Bank Account <span class="required">*</span></label>
            <select formControlName="bankAccountId" class="form-control">
              <option [ngValue]="null">Select Bank Account</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.bankName }} - {{ account.accountNumber }}
              </option>
            </select>
            <small class="error-message" *ngIf="editForm.get('bankAccountId')?.invalid && editForm.get('bankAccountId')?.touched">
              Bank Account is required
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Deposit Date <span class="required">*</span></label>
            <input type="date" formControlName="depositDate" class="form-control">
            <small class="error-message" *ngIf="editForm.get('depositDate')?.invalid && editForm.get('depositDate')?.touched">
              Deposit Date is required
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Amount <span class="required">*</span></label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input type="text" formControlName="depositAmount" class="form-control" 
                placeholder="0.00"
                indianCurrencyFormat
                min="1" step="0.01">
            </div>
            <small class="error-message" *ngIf="editForm.get('depositAmount')?.invalid && editForm.get('depositAmount')?.touched">
              Amount must be greater than 0
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Reference Number</label>
            <input type="text" formControlName="referenceNumber" class="form-control">
          </div>

          <div class="form-group">
            <label class="form-label">Payment Mode <span class="required">*</span></label>
            <select formControlName="paymentMode" class="form-control">
              <option value="">Select Payment Mode</option>
              <option *ngFor="let mode of paymentModes" [value]="mode.name">
                {{ mode.name }}
              </option>
            </select>
            <small class="error-message" *ngIf="editForm.get('paymentMode')?.invalid && editForm.get('paymentMode')?.touched">
              Payment Mode is required
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea formControlName="notes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isEditSubmitting">Cancel</button>
        <button class="btn btn-primary" (click)="saveEditedDeposit()" [disabled]="editForm.invalid || isEditSubmitting">
          {{ isEditSubmitting ? 'Saving...' : 'Save Changes' }}
        </button>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div *ngIf="selectedDeposit" class="modal-overlay" (click)="closeViewModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Deposit Details - #{{ selectedDeposit.id }}</h3>
        <button class="modal-close" (click)="closeViewModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="details-section">
          <div class="detail-row">
            <span class="label">Deposit Date:</span>
            <span class="value">{{ selectedDeposit.depositDate | date: 'dd MMM yyyy' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Bank Account:</span>
            <span class="value">{{ getBankAccountName(selectedDeposit.bankAccountId) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Amount:</span>
            <span class="value">₹{{ selectedDeposit.depositAmount | number: '1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Reference Number:</span>
            <span class="value">{{ selectedDeposit.referenceNumber || '-' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Payment Mode:</span>
            <span class="value">{{ selectedDeposit.paymentMode }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedDeposit.notes">
            <span class="label">Notes:</span>
            <span class="value">{{ selectedDeposit.notes }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeViewModal()">Close</button>
      </div>
    </div>
  </div>
</div>
