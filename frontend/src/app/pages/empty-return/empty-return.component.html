<div class="sale-entry-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Empty Cylinder Return</h1>
    <p class="page-subtitle">Record a return of empty cylinders from a customer</p>
  </div>

  <!-- Empty Return Form -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Return Details</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="emptyReturnForm" (ngSubmit)="submit()" class="sale-form">
        <!-- Two Column Layout for Selection Fields -->
        <div class="form-row">
          <!-- Warehouse Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Warehouse"
              [required]="true"
              [items]="warehouses"
              [displayKey]="'name'"
              placeholder="Warehouse name..."
              (selectedChange)="onWarehouseSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="emptyReturnForm.get('warehouseId')?.invalid && emptyReturnForm.get('warehouseId')?.touched" class="error-message">
              Warehouse is required
            </div>
          </div>

          <!-- Customer Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Customer"
              [required]="true"
              [items]="customers"
              [displayKey]="'name'"
              placeholder="Select a customer"
              (selectedChange)="onCustomerSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="emptyReturnForm.get('customerId')?.invalid && emptyReturnForm.get('customerId')?.touched" class="error-message">
              Customer is required
            </div>
          </div>
        </div>

        <!-- Variant Selection -->
        <app-autocomplete-input
          #variantAutocomplete
          label="Cylinder Variant"
          [required]="true"
          [items]="filteredVariants"
          [displayKey]="'name'"
          placeholder="Select variant"
          (selectedChange)="onVariantSelected($event)"
        ></app-autocomplete-input>
        <div *ngIf="emptyReturnForm.get('variantId')?.invalid && emptyReturnForm.get('variantId')?.touched" class="error-message">
          Variant is required
        </div>

        <div class="form-row">
          <!-- Empty Cylinders Returned -->
          <div class="form-group">
            <label class="form-label">Empty Cylinders Returned <span class="required">*</span></label>
            <input formControlName="emptyIn" type="number" min="1" class="form-control" required placeholder="0" />
            <div *ngIf="emptyReturnForm.get('emptyIn')?.invalid && emptyReturnForm.get('emptyIn')?.touched" class="error-message">
              Valid quantity required
            </div>
            <div class="balance-info" *ngIf="balanceLoading">
              <span class="balance-label">Current balance</span>
              <span class="balance-value">Loading...</span>
            </div>
            <div class="balance-info" *ngIf="!balanceLoading && currentBalance !== null">
              <span class="balance-label">Current balance</span>
              <span class="balance-value">{{ currentBalance }} cylinders</span>
            </div>
            <div class="balance-info balance-info-error" *ngIf="!balanceLoading && balanceError">
              <span class="balance-label">Current balance</span>
              <span class="balance-value">{{ balanceError }}</span>
            </div>
          </div>
          <!-- Date -->
          <div class="form-group">
            <label class="form-label">Date <span class="required">*</span></label>
            <input formControlName="transactionDate" type="date" class="form-control" required />
          </div>
        </div>

        <!-- Two Column Layout for Amount and Payment Mode -->
        <div class="form-row">
          <!-- Amount Received -->
          <div class="form-group">
            <label class="form-label">Amount Received (₹)</label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input 
                formControlName="amountReceived" 
                type="text" 
                class="form-control" 
                placeholder="0.00"
                indianCurrencyFormat>
            </div>
            <div class="balance-info" *ngIf="dueLoading">
              <span class="balance-label">Current due</span>
              <span class="balance-value">Loading...</span>
            </div>
            <div class="balance-info" *ngIf="!dueLoading && currentDue !== null">
              <span class="balance-label">Current due</span>
              <span class="balance-value">{{ currentDue | indianCurrency }}</span>
            </div>
            <div class="balance-info balance-info-error" *ngIf="!dueLoading && dueError">
              <span class="balance-label">Current due</span>
              <span class="balance-value">{{ dueError }}</span>
            </div>
          </div>

          <!-- Payment Mode -->
          <div class="form-group">
            <label class="form-label">Payment Mode</label>
            <select formControlName="paymentMode" class="form-control">
              <option value="" disabled selected hidden>Select Payment Mode</option>
              <option *ngFor="let mode of paymentModes" [value]="mode.name">{{ mode.name }}</option>
            </select>
          </div>

          <div class="form-group" *ngIf="emptyReturnForm.get('paymentMode')?.value && getSelectedPaymentMode(emptyReturnForm.get('paymentMode')?.value)?.isBankAccountRequired">
            <label class="form-label">Bank Account <span class="required">*</span></label>
            <select formControlName="bankAccountId" class="form-control">
              <option [value]="null" disabled>Select Bank Account</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.bankName }} - {{ account.accountNumber }}
              </option>
            </select>
            <div *ngIf="emptyReturnForm.get('bankAccountId')?.invalid && emptyReturnForm.get('bankAccountId')?.touched" class="error-message">
              Bank account is required for this payment mode
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="submitting || emptyReturnForm.invalid">Save</button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="submitting">Reset</button>
        </div>
        <!-- Success Message removed: Toastr handles popup notification -->
      </form>
    </div>
  </div>
</div>
