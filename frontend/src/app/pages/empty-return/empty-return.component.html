<div class="sale-entry-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Empty Cylinder Return</h1>
    <p class="page-subtitle">Record a return of empty cylinders from a customer</p>
  </div>

  <!-- Empty Return Form -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Return Details</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="emptyReturnForm" (ngSubmit)="submit()" class="sale-form">
        <!-- Two Column Layout for Selection Fields -->
        <div class="form-row">
          <!-- Warehouse Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Warehouse"
              [required]="true"
              [items]="warehouses"
              [displayKey]="'name'"
              placeholder="Warehouse name..."
              (selectedChange)="onWarehouseSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="emptyReturnForm.get('warehouseId')?.invalid && emptyReturnForm.get('warehouseId')?.touched" class="error-message">
              Warehouse is required
            </div>
          </div>

          <!-- Customer Selection (Autocomplete) -->
          <div class="form-group">
            <app-autocomplete-input
              label="Customer"
              [required]="true"
              [items]="customers"
              [displayKey]="'name'"
              placeholder="Select a customer"
              (selectedChange)="onCustomerSelected($event)"
            ></app-autocomplete-input>
            <div *ngIf="emptyReturnForm.get('customerId')?.invalid && emptyReturnForm.get('customerId')?.touched" class="error-message">
              Customer is required
            </div>
          </div>
        </div>

        <!-- Variant Selection -->
        <app-autocomplete-input
          label="Cylinder Variant"
          [required]="true"
          [items]="filteredVariants"
          [displayKey]="'name'"
          placeholder="Select variant"
          (selectedChange)="onVariantSelected($event)"
        ></app-autocomplete-input>
        <div *ngIf="emptyReturnForm.get('variantId')?.invalid && emptyReturnForm.get('variantId')?.touched" class="error-message">
          Variant is required
        </div>

        <div class="form-row">
          <!-- Empty Cylinders Returned -->
          <div class="form-group">
            <label class="form-label">Empty Cylinders Returned <span class="required">*</span></label>
            <input formControlName="emptyIn" type="number" min="1" class="form-control" required placeholder="0" />
            <div *ngIf="emptyReturnForm.get('emptyIn')?.invalid && emptyReturnForm.get('emptyIn')?.touched" class="error-message">
              Valid quantity required
            </div>
          </div>
          <!-- Date -->
          <div class="form-group">
            <label class="form-label">Date <span class="required">*</span></label>
            <input formControlName="transactionDate" type="date" class="form-control" required />
          </div>
        </div>

        <!-- Two Column Layout for Amount and Payment Mode -->
        <div class="form-row">
          <!-- Amount Received -->
          <div class="form-group">
            <label class="form-label">Amount Received (₹)</label>
            <div class="input-with-prefix">
              <span class="currency">₹</span>
              <input 
                formControlName="amountReceived" 
                type="number" 
                class="form-control" 
                placeholder="0.00"
                step="0.01"
                min="0">
            </div>
          </div>

          <!-- Payment Mode -->
          <div class="form-group">
            <label class="form-label">Payment Mode</label>
            <select formControlName="paymentMode" class="form-control">
              <option value="" disabled selected hidden>Select Payment Mode</option>
              <option value="CASH">Cash</option>
              <option value="CHEQUE">Cheque</option>
              <option value="BANK_TRANSFER">Bank Transfer</option>
              <option value="CREDIT">Credit</option>
              <option value="UPI">UPI</option>
            </select>
          </div>

          <div class="form-group" *ngIf="emptyReturnForm.get('paymentMode')?.value && emptyReturnForm.get('paymentMode')?.value.toUpperCase() !== 'CASH'">
            <label class="form-label">Bank Account</label>
            <select formControlName="bankAccountId" class="form-control">
              <option [value]="null" disabled>Select Bank Account</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.bankName }} - {{ account.accountNumber }}
              </option>
            </select>
            <div *ngIf="emptyReturnForm.get('bankAccountId')?.invalid && emptyReturnForm.get('bankAccountId')?.touched" class="error-message">
              Bank account is required for non-cash payments
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="submitting || emptyReturnForm.invalid">
            <span>✓</span> Record Return
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="submitting">
            <span>↻</span> Reset
          </button>
        </div>
        <!-- Success Message removed: Toastr handles popup notification -->
      </form>
    </div>
  </div>
</div>
