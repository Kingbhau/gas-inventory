<div class="supplier-transaction-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Supplier Transactions</h1>
    <button (click)="openAddForm()" class="btn btn-primary">+ New Transaction</button>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <!-- Row 1: From Date, To Date, Supplier -->
    <div class="filter-row three-col">
      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <input type="date" [(ngModel)]="filterFromDate" class="filter-input">
      </div>
      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <input type="date" [(ngModel)]="filterToDate" class="filter-input" [min]="filterFromDate">
      </div>
      <div class="filter-group">
        <label class="filter-label">Supplier</label>
        <select [(ngModel)]="selectedSupplier" class="filter-input">
          <option value="">All Suppliers</option>
          <option *ngFor="let supplier of suppliers" [value]="supplier.id?.toString()">{{ supplier.name }}</option>
        </select>
      </div>
    </div>
    <!-- Row 2: Warehouse, Variant, Reference -->
    <div class="filter-row three-col">
      <div class="filter-group">
        <label class="filter-label">Warehouse</label>
        <select [(ngModel)]="selectedWarehouse" class="filter-input">
          <option value="">All Warehouses</option>
          <option *ngFor="let warehouse of warehouses" [value]="warehouse.id?.toString()">{{ warehouse.name }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Variant</label>
        <select [(ngModel)]="filterVariantId" class="filter-input">
          <option value="">All Variants</option>
          <option *ngFor="let variant of variants" [value]="variant.id?.toString()">{{ variant.name }}</option>
        </select>
      </div>
      <div class="filter-group">
        <app-autocomplete-input
          label="Created By"
          [labelClass]="'filter-label'"
          [items]="users"
          [displayKey]="'name'"
          placeholder="All Users"
          (selectedChange)="filterCreatedBy = $event?.username || ''"
        ></app-autocomplete-input>
      </div>
      <div class="filter-group">
        <label class="filter-label">Reference #</label>
        <input type="text" [(ngModel)]="filterReference" class="filter-input" placeholder="Reference number">
      </div>
    </div>
    <!-- Row 3: Buttons -->
    <div class="filter-actions-row">
      <button (click)="applyFilters()" class="btn btn-primary">Search</button>
      <button (click)="resetFilters()" class="btn btn-secondary">Reset</button>
      <button (click)="exportSupplierTransactionsPDF()" class="btn btn-secondary">
        <fa-icon [icon]="faDownload"></fa-icon> Export PDF
      </button>
    </div>
  </div>




  <!-- Transactions Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Transaction History</h3>
      <span class="record-count">{{ totalTransactions }} transactions</span>
    </div>
    <div class="card-body">
      <div *ngIf="paginatedTransactions.length > 0; else noData" class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Supplier</th>
              <th>Variant</th>
              <th class="text-center">Filled Received</th>
              <th class="text-center">Empty Returned</th>
              <th class="text-center">Amount</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let transaction of paginatedTransactions">
              <td>{{ transaction.transactionDate | date: 'dd MMM yyyy' }}</td>
              <td><strong>{{ transaction.supplierName }}</strong></td>
              <td>{{ transaction.variantName }}</td>
              <td class="text-center received">{{ transaction.filledReceived }} units</td>
              <td class="text-center returned">{{ transaction.emptySent }} units</td>
              <td class="text-center">{{ transaction.amount | number:'1.2-2' }}</td>
              <td class="text-center">
                <button class="btn-action" (click)="viewTransactionDetails(transaction)" title="View Details" style="margin-right: 0.5rem;">
                  <fa-icon [icon]="faEye"></fa-icon>
                </button>
                <button class="btn-action" (click)="editTransaction(transaction)" title="Edit"><fa-icon [icon]="faEdit"></fa-icon></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- Pagination Controls -->
      <div *ngIf="paginatedTransactions.length > 0" class="pagination">
        <button 
          (click)="onPageChange(transactionPage - 1)" 
          [disabled]="transactionPage === 1"
          class="btn btn-secondary">
          ← Previous
        </button>
        <span class="page-info">Page {{ transactionPage }} of {{ getTotalPages() }}</span>
        <button 
          (click)="onPageChange(transactionPage + 1)" 
          [disabled]="transactionPage === getTotalPages()"
          class="btn btn-secondary">
          Next →
        </button>
        <div style="display: flex; align-items: center; gap: 0.25rem; margin-left: 2rem;">
          <span class="page-size-label">Show</span>
          <select [(ngModel)]="transactionPageSize" (ngModelChange)="onPageSizeChange($event)" class="page-size-select">
            <option *ngFor="let size of [5,10,20,50,100]" [value]="size">{{ size }}</option>
          </select>
          <span class="page-size-label">per page</span>
        </div>
      </div>

      <ng-template #noData>
        <div class="no-data">
          <p><fa-icon [icon]="faBox"></fa-icon> No transactions found</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showForm" class="modal-overlay" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingId ? 'Edit Transaction' : 'New Supplier Transaction' }}</h2>
        <button class="modal-close" (click)="closeForm()">✕</button>
      </div>
      <form [formGroup]="transactionForm" (ngSubmit)="saveTransaction()" class="modal-body">
        <div class="form-group">
          <label class="form-label">Warehouse <span class="required">*</span></label>
          <ng-container *ngIf="editingId; else warehouseSelect">
            <!-- Read-only warehouse display during edit -->
            <div class="form-control" style="background-color: #f5f5f5; cursor: not-allowed; display: flex; align-items: center; height: 38px;">
              {{ getSelectedWarehouseName() }}
            </div>
          </ng-container>
          <ng-template #warehouseSelect>
            <!-- Editable warehouse select for new transaction -->
            <select formControlName="warehouseId" class="form-control" [compareWith]="warehouseCompare">
              <option [ngValue]="null">Select a warehouse</option>
              <option *ngFor="let warehouse of warehouses" [ngValue]="warehouse.id">{{ warehouse.name }}</option>
            </select>
          </ng-template>
          <div *ngIf="transactionForm.get('warehouseId')?.invalid && transactionForm.get('warehouseId')?.touched" class="error-message">
            Warehouse is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Supplier <span class="required">*</span></label>
          <select formControlName="supplierId" class="form-control">
            <option value="">Select a supplier</option>
            <option *ngFor="let supplier of suppliers" [value]="supplier.id">{{ supplier.name }}</option>
          </select>
          <div *ngIf="transactionForm.get('supplierId')?.invalid && transactionForm.get('supplierId')?.touched" class="error-message">
            Supplier is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Variant <span class="required">*</span></label>
          <select formControlName="variantId" class="form-control">
            <option value="">Select variant</option>
            <option *ngFor="let variant of variants" [value]="variant.id">{{ variant.name }}</option>
          </select>
          <div *ngIf="transactionForm.get('variantId')?.invalid && transactionForm.get('variantId')?.touched" class="error-message">
            Variant is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Date <span class="required">*</span></label>
          <input formControlName="transactionDate" type="date" class="form-control">
          <div *ngIf="transactionForm.get('transactionDate')?.invalid && transactionForm.get('transactionDate')?.touched" class="error-message">
            Date is required
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Filled Cylinders Received <span class="required">*</span></label>
            <input formControlName="filledReceived" type="number" class="form-control" placeholder="0">
            <div *ngIf="transactionForm.get('filledReceived')?.invalid && transactionForm.get('filledReceived')?.touched" class="error-message">
              Valid quantity required
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Empty Cylinders Sent <span class="required">*</span></label>
            <input formControlName="emptySent" type="number" class="form-control" placeholder="0">
            <div *ngIf="transactionForm.get('emptySent')?.invalid && transactionForm.get('emptySent')?.touched" class="error-message">
              Valid quantity required
            </div>
          </div>
        </div>

        <div class="form-group" *ngIf="editingId !== null">
          <label class="form-label">Reference Number</label>
          <input formControlName="reference" type="text" class="form-control" placeholder="e.g., SUP-001" readonly style="background-color: #f5f5f5;">
        </div>

        <div class="form-group">
          <label class="form-label">Amount <span class="required">*</span></label>
          <input formControlName="amount" type="text" class="form-control" placeholder="0.00" indianCurrencyFormat>
          <div *ngIf="transactionForm.get('amount')?.invalid && transactionForm.get('amount')?.touched" class="error-message">
            Valid amount required
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" [disabled]="!transactionForm.valid">Save</button>
          <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Transaction Details Modal -->
  <div *ngIf="selectedTransaction" class="modal-overlay" (click)="closeTransactionDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Transaction Details</h2>
        <button class="modal-close" (click)="closeTransactionDetails()">✕</button>
      </div>
      <div class="modal-body">
        <div class="invoice-section">
          <div class="invoice-row">
            <span class="label">Date:</span>
            <span class="value">{{ selectedTransaction.transactionDate | date: 'dd MMM yyyy' }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Reference Number:</span>
            <span class="value">{{ selectedTransaction.reference || '-' }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Warehouse:</span>
            <span class="value">{{ selectedTransaction.warehouseName }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Supplier:</span>
            <span class="value">{{ selectedTransaction.supplierName }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Variant:</span>
            <span class="value">{{ selectedTransaction.variantName }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Filled Received:</span>
            <span class="value">{{ selectedTransaction.filledReceived }} units</span>
          </div>
          <div class="invoice-row">
            <span class="label">Empty Returned:</span>
            <span class="value">{{ selectedTransaction.emptySent }} units</span>
          </div>
          <div class="invoice-row total">
            <span class="label">Amount:</span>
            <span class="value">{{ selectedTransaction.amount | number:'1.2-2' }}</span>
          </div>
          <div class="invoice-row">
            <span class="label">Created By:</span>
            <span class="value">{{ getCreatedByName(selectedTransaction.createdBy) }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeTransactionDetails()" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

</div>
